<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />

    <title>GASMAN â€“ Navigation</title>

    <!-- CSS -->
    <link rel="stylesheet" href="/static/styles.css" />

    <!-- Bootstrap CSS -->
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />

    <!-- Icons -->
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <!-- Custom App JS -->
    <script src="/static/script.js"></script>

    <!-- Google Maps -->
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key={{ google_api_key }}&libraries=geometry,places&loading=async&callback=_initMapImpl">
    </script>
</head>

<body>

<nav class="navbar bg-white shadow-sm px-3 d-flex justify-content-between">
    <div class="d-flex align-items-center gap-3">
        <span class="fw-bold"><i class="fas fa-satellite-dish me-2"></i>GASMAN</span>
    </div>

    <div class="d-flex align-items-center gap-3">
        <span>Welcome, Captain {{ user_name }}</span>
        <a href="/logout" class="btn btn-danger btn-sm">Logout</a>
    </div>
</nav>

<div class="container mt-3">

    <!-- ========================= TABS ========================= -->
    <ul class="nav nav-tabs">
        <li class="nav-item">
            <button class="nav-link active" id="drive-tab"
                data-bs-toggle="tab" data-bs-target="#driveTabContent">
                <i class="fas fa-route"></i> Drive Mode
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" id="device-tab"
                data-bs-toggle="tab" data-bs-target="#deviceTabContent">
                <i class="fas fa-list"></i> Device Information
            </button>
        </li>
    </ul>

    <div class="tab-content">

        <!-- ========================= DRIVE MODE ========================= -->
        <div class="tab-pane fade show active" id="driveTabContent">
            <div class="card mt-3 p-2 position-relative">
                <div id="map" class="map-card"></div>

                <!-- Navigation Banner -->
                <div id="navBanner" class="nav-banner">
                    <div class="nav-row">
                        <div id="navTurnIcon" class="nav-icon">â¬†</div>

                        <div class="nav-instruction">
                            <div id="navTextMain" class="nav-main"></div>
                            <div id="navTextSub" class="nav-sub"></div>
                        </div>

                        <!-- Voice Toggle -->
                        <div class="nav-audio">
                            <i id="navAudioBtn" class="fa fa-volume-up"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========================= DEVICE INFORMATION ========================= -->
        <div class="tab-pane fade" id="deviceTabContent">

            <div class="card mt-3 p-3">

                <!-- ðŸ”Ž GLOBAL SEARCH + SORT BAR -->
                <div class="d-flex flex-wrap align-items-center gap-3 mb-3 p-2 border rounded bg-light">

                    <!-- SEARCH DEVICE ID -->
                    <input id="globalSearch" type="text" class="form-control"
                           placeholder="Search Device ID"
                           style="max-width: 260px;">

                    <!-- SORT: DEVICE ID -->
                    <div class="btn-group">
                        <button class="btn btn-outline-secondary btn-sm" onclick="globalSort('id','asc')">
                            Device â–²
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="globalSort('id','desc')">
                            Device â–¼
                        </button>
                    </div>

                    <!-- SORT: STATUS (GAS%) -->
                    <div class="btn-group">
                        <button class="btn btn-outline-secondary btn-sm" onclick="globalSort('gas','asc')">
                            Status â–²
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="globalSort('gas','desc')">
                            Status â–¼
                        </button>
                    </div>

                </div>

                <!-- ============ LOW GAS DEVICES ============ -->
                <div class="device-section mt-2">
                    <div class="section-header text-dark fw-bold mb-2">
                        Low Gas Level Devices
                    </div>

                    <div class="card p-2">
                        <table class="table table-sm table-striped mb-0 table-fixed">
                            <thead>
                                <tr>
                                    <th>Device ID</th>
                                    <th class="text-center">Status</th>
                                </tr>
                            </thead>
                            <tbody id="lowGasTable">
                                <tr><td colspan="2" class="text-center text-muted">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- ============ NORMAL GAS DEVICES ============ -->
                <div class="device-section mt-4">
                    <div class="section-header text-dark fw-bold mb-2">
                        Normal Gas Level Devices
                    </div>

                    <div class="card p-2">
                        <table class="table table-sm table-striped mb-0 table-fixed">
                            <thead>
                                <tr>
                                    <th>Device ID</th>
                                    <th class="text-center">Status</th>
                                </tr>
                            </thead>
                            <tbody id="normalGasTable">
                                <tr><td colspan="2" class="text-center text-muted">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>

    </div>
</div>


<!-- ========================= DEVICE MODAL ========================= -->
<div class="modal fade" id="deviceDetailModal">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 id="deviceDetailModalLabel">Device Details</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div id="deviceDetailModalBody" class="modal-body">Loadingâ€¦</div>
        </div>
    </div>
</div>


<!-- Bootstrap -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>


<!-- ========================= GLOBAL SEARCH + SORT + MODAL SCRIPT ========================= -->
<script>

(function(){

    // Load data when switching tab
    document.getElementById("device-tab")
        .addEventListener("shown.bs.tab", loadDeviceData);

    // Search filter
    document.getElementById("globalSearch")
        .addEventListener("keyup", applyFilters);

    // SORT BUTTON LOGIC
    window.globalSort = function(type, dir) {
        const cache = window._deviceCombinedCache;
        if (!cache) return;

        cache.low_gas.sort((a,b)=>sortLogic(a,b,type,dir));
        cache.normal_gas.sort((a,b)=>sortLogic(a,b,type,dir));

        applyFilters();
    };

    function sortLogic(a,b,type,dir) {
        if (type === "id") {
            return dir==="asc"
                ? a.device_id.localeCompare(b.device_id)
                : b.device_id.localeCompare(a.device_id);
        }
        if (type === "gas") {
            return dir==="asc"
                ? (a.gas_percentage||0) - (b.gas_percentage||0)
                : (b.gas_percentage||0) - (a.gas_percentage||0);
        }
    }

    // Filter both lists during search
    function applyFilters() {
        const txt = document.getElementById("globalSearch").value.toLowerCase();
        const cache = window._deviceCombinedCache;
        if (!cache) return;

        const low = cache.low_gas.filter(d => d.device_id.toLowerCase().includes(txt));
        const normal = cache.normal_gas.filter(d => d.device_id.toLowerCase().includes(txt));

        renderLow(low);
        renderNormal(normal);
    }

    // Fetch data from backend
    function loadDeviceData() {
        fetch("/device_info_combined")
            .then(r=>r.json())
            .then(data=>{
                window._deviceCombinedCache = data;
                applyFilters();
            });
    }

    // =============== TABLE RENDER FUNCTIONS ===============
    function renderLow(list) {
        const body = document.getElementById("lowGasTable");
        body.innerHTML = "";

        if (!list.length) {
            body.innerHTML = `<tr><td colspan="2" class="text-center text-muted">No low gas devices</td></tr>`;
            return;
        }

        list.forEach(d=>{
            body.innerHTML += `
                <tr data-id="${d.device_id}">
                    <td>${d.device_id}</td>
                    <td class="text-center">
                        <span class="badge bg-danger">
                            Low Gas Level (${d.gas_percentage}%)
                        </span>
                    </td>
                </tr>`;
        });
    }

    function renderNormal(list) {
        const body = document.getElementById("normalGasTable");
        body.innerHTML = "";

        if (!list.length) {
            body.innerHTML = `<tr><td colspan="2" class="text-center text-muted">No normal gas devices</td></tr>`;
            return;
        }

        list.forEach(d=>{
            const statusText = d.gas_percentage !== null
                ? `Normal Gas Level (${d.gas_percentage}%)`
                : "No Data";

            body.innerHTML += `
                <tr data-id="${d.device_id}">
                    <td>${d.device_id}</td>
                    <td class="text-center">
                        <span class="badge bg-success">${statusText}</span>
                    </td>
                </tr>`;
        });
    }

})();


// ======================= DEVICE DETAILS MODAL CLICK HANDLER =======================
document.addEventListener("click", function (e) {

    const row = e.target.closest("tr[data-id]");
    if (!row) return;

    const deviceId = row.getAttribute("data-id");

    // Read from combined cache
    const all = window._deviceCombinedCache;
    if (!all) return;

    let d =
        all.low_gas.find(x => x.device_id === deviceId) ||
        all.normal_gas.find(x => x.device_id === deviceId);

    if (!d) return;

    // Fill modal
    const modalBody = document.getElementById("deviceDetailModalBody");
    const modalTitle = document.getElementById("deviceDetailModalLabel");

    modalTitle.innerText = `Device ${d.device_id}`;

    modalBody.innerHTML = `
        <table class="table">
            <tr><th>Device ID</th><td>${d.device_id}</td></tr>
            <tr><th>Gas Level</th><td>${d.gas_percentage ?? "N/A"}%</td></tr>
            <tr><th>Threshold</th><td>${d.threshold_percent ?? "N/A"}%</td></tr>
            <tr><th>Customer</th><td>${d.customer_name ?? ""}</td></tr>
            <tr><th>Location</th><td>${d.device_location ?? ""}</td></tr>
            <tr><th>Coordinates</th><td>${d.coordinates ?? ""}</td></tr>
            <tr><th>Last Log</th><td>${d.last_log_time ?? ""}</td></tr>
            <tr><th>Status</th><td>${d.device_status}</td></tr>
        </table>
    `;

    new bootstrap.Modal(document.getElementById("deviceDetailModal")).show();
});
</script>

</body>
</html>
